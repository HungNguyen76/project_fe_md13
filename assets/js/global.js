let listProductsStock = [
  {
    img: "/assets/images/productItem/air-jordan-9-retro-mens-shoes-3WfxKt.png",
    name: "Air Jordan 9 Retro",
    des: "Celebrating its 30th anniversary—and the first release with original design specs since the '93 debut—the AJ9 is back. We kept all the iconic details, like the minimalist leather upper, lacing system and jagged midsole. Step in and throw it back.",
    price: 14.9,
    type: "MEN",
    options: [
      {
        src: "/assets/images/productItem/air-jordan-9-retro-mens-shoes-3WfxKt-FQ8992-101.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "/assets/images/productItem/air-jordan-9-retro-mens-shoes-3WfxKt-FQ8992-102.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "/assets/images/productItem/air-jordan-9-retro-mens-shoes-3WfxKt-FQ8992-103.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
    ],
  },
  {
    img: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/ecdf5522-ebbf-4252-93e4-fc2c12d2ea29/air-jordan-1-low-shoes-6Q1tFM.png",
    name: "Air Jordan 1 Low",
    des: "Inspired by the original that debuted in 1985, the Air Jordan 1 Low offers a clean, classic look that's familiar yet always fresh. With an iconic design that pairs perfectly with any 'fit, these kicks ensure you'll always be on point.",
    price: 100.5,
    type: "MEN",
    options: [
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/df27052d-2d06-47fc-bc05-e285f08e4965/air-jordan-1-low-shoes-6Q1tFM.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/fd808f28-21d1-4031-a8ef-3b2f6398cfa0/air-jordan-1-low-shoes-6Q1tFM.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/edaf636d-5d82-42f0-86d0-7459d6f3a6fb/air-jordan-1-low-shoes-6Q1tFM.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
    ],
  },
  {
    img: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/aff63355-b2e9-47fb-adae-4b60ba1f602e/air-jordan-1-mid-shoes-SQf7DM.png",
    name: "Air Jordan 1 Mid",
    des: "Inspired by the original AJ1, this mid-top edition maintains the iconic look you love while choice colours and crisp leather give it a distinct identity.",
    price: 90.5,
    type: "MEN",
    options: [
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/a842a15a-f4f2-4211-9a13-6cf82d6770e9/air-jordan-1-mid-shoes-SQf7DM.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/288a2235-54ce-4f8e-a133-0117cbc381b4/air-jordan-1-mid-shoes-SQf7DM.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/4f864b95-0da2-4f66-b1c7-2cfb6e655bc6/air-jordan-1-mid-shoes-SQf7DM.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
    ],
  },
  {
    img: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/45d37b3f-7afa-4263-82cb-792b770b7fb8/jordan-max-aura-5-shoes-ZBZ4Pz.png",
    name: "Jordan Max Aura 5",
    des: "When you need a shoe that's ready 24/7, it's gotta be the Max Aura 5. Inspired by the AJ3, this pair of kicks puts a modern spin on the classic. They're made from durable leather and textiles that sit atop a heel of Nike Air cushioning so you can walk, run or skate all day and still have fresh-feeling soles.",
    price: 105.5,
    type: "MEN",
    options: [
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/45d37b3f-7afa-4263-82cb-792b770b7fb8/jordan-max-aura-5-shoes-ZBZ4Pz.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/902b0fb0-ab1e-4213-ab91-3e08c124093c/jordan-max-aura-5-shoes-ZBZ4Pz.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
      {
        src: "https://static.nike.com/a/images/t_PDP_1728_v1/f_auto,q_auto:eco,u_126ab356-44d8-4a06-89b4-fcdcc8df0245,c_scale,fl_relative,w_1.0,h_1.0,fl_layer_apply/2c87b88f-9873-46e6-9929-ccafa445e49b/jordan-max-aura-5-shoes-ZBZ4Pz.png",
        sizes: [
          {
            key: "S",
            stock: 10,
          },
          {
            key: "M",
            stock: 10,
          },
          {
            key: "L",
            stock: 10,
          },
        ],
      },
    ],
  },
];

function uuid() {
  return new Date().getMilliseconds() + Math.floor(Math.random() * 999999999);
}

for (let i = 0; i < listProductsStock.length; i++) {
  listProductsStock[i].id = uuid();
  listProductsStock[i].quantity = 1;
}


for (let i = 0; i < listProductsStock.length; i++) {
  for (let j = 0; j < listProductsStock[i].options.length; j++) {
      listProductsStock[i].options[j].idOption = uuid();
  }
}

localStorage.setItem("listProducts", JSON.stringify(listProductsStock));


//Xử lý tự động thêm tài khoản admin vào mỗi khi load trang web. có thêm isAdmin: true, để check người 
//dùng có phải admin hay không
let listUsers = JSON.parse(localStorage.getItem("listUsers")) || [];
listUsers.push({
  idUser: 709428841,
  email: "admin@gmail.com",
  password: "123456",
  password_confirmation: "123456",
  cartUser: [],
  isAdmin: true
})
localStorage.setItem("listUsers", JSON.stringify(listUsers));

// Hàm convert tiền tệ
const USDollar = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD',
});
const VND = new Intl.NumberFormat('vi-VN', {
  style: 'currency',
  currency: 'VND',
});

window.onload = function () {
  const bar = document.getElementById("bar");
  const close = document.getElementById("close");
  const nav = document.getElementById("navbar");

  if (bar) {
      bar.addEventListener("click", () => {
          nav.classList.add("active");
      });
  }

  if (close) {
      close.addEventListener("click", () => {
          nav.classList.remove("active");
      });
  }
};

// Create a Fixed Header on Scroll
window.onscroll = function () { myFunction() };

let header = document.querySelector(".nagivation-container");
let sticky = header.offsetTop;

function myFunction() {
  if (window.pageYOffset > sticky) {
      header.classList.add("sticky");
  } else {
      header.classList.remove("sticky");
  }
}

// Hàm hiển thị banner
let slideIndex = 1;
// call showDivs() to display the first image
showDivs(slideIndex);

function plusDivs(n) {
  showDivs(slideIndex += n);
}

// Hàm này dùng để ẩn đi (display="none") tất cả thẻ elements có class là "mySlides", 
// và hiển thị (display="block") với thẻ có slideIndex được cho
function showDivs(n) {
  let i;
  let x = document.getElementsByClassName("mySlides");
  if (n > x.length) { slideIndex = 1 }
  if (n < 1) { slideIndex = x.length }
  // Hides (display="none") all elements with the class name "mySlides"
  for (i = 0; i < x.length; i++) {
      x[i].style.display = "none";
  }
  x[slideIndex - 1].style.display = "block";
}

// Hàm tìm kiếm sản phẩm  
function searchProduct() {
  document.querySelector(".search-input").style.visibility = "visible";
}

function closeSearchProduct() {
  document.querySelector(".search-input").style.visibility = "hidden";
}

function deleteSearchInput() {
  document.querySelector(".search-product").value = "";
  document.querySelector(".searchProduct-container").innerHTML = "";
  document.querySelector(".content-container").style.opacity = 1;
}

function searchInputProduct() {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let valueInputSearch = document.querySelector(".search-product").value;
  let userSearch = listProducts.filter((item) => {
      return item.name.toUpperCase().includes(valueInputSearch.toUpperCase())
  })

  renderSearchInputProduct(userSearch);
}

// Hàm xử lí khi người dùng xoá hết dữ liệu trong ô input thì ẩn vùng hiển thị sản phẩm người dùng đã tìm kiếm
document.querySelector(".search-product").addEventListener("input", handleInputClear);

function handleInputClear() {
  let valueInputSearch = document.querySelector(".search-product").value;

  if (valueInputSearch === "") {
      clearSearchResults();
      document.querySelector(".content-container").style.opacity = 1;
  }
}

function clearSearchResults() {
  document.querySelector(".searchProduct-container").innerHTML = "";
}

// Hàm xử lí khi click vào các vùng khác thì ẩn vùng hiển thị sản phẩm người dùng đã tìm kiếm
document.addEventListener("click", handleClickOutside);

function handleClickOutside(event) {
  const searchContainer = document.querySelector(".searchProduct-container");
  const cartProductItem = document.querySelector(".cart-product");
  const target = event.target;

  // Kiểm tra xem người dùng có click vào phần bên ngoài vùng hiển thị sản phẩm người dùng đã tìm kiếm hay không
  if (!searchContainer.contains(target) && !cartProductItem.contains(target)) {
      clearSearchResults();
      document.querySelector(".content-container").style.opacity = 1;
  }
}

// Hàm hiển thị sản phẩm khi người dùng nhập dữ liệu vào ô tìm kiếm
function renderSearchInputProduct(params) {
  let result = "";
  for (let i = 0; i < params.length; i++) {
      result += `
          <div class="seacrh-ProductItem" onclick="renderProductItem('${params[i].id}')">
              <div class="seacrh-ProductItem-image">
                  <img src="${params[i].img}" alt="">
              </div>
              <div class="seacrh-ProductItem-info">
                  <h4>${params[i].name}</h4>
                  <p>${USDollar.format(params[i].price)}</p>
              </div>
          </div>
      `;
  }
  document.querySelector(".searchProduct-container").innerHTML = result;
  document.querySelector(".content-container").style.opacity = 0.5;
}


if (checkLogin()) {
  document.querySelector(".login-button").style.display = "none";
  document.querySelector(".logout-button").style.display = "block";
}

if (checkIsAdmin()) {
  document.querySelector(".admin").style.display = "block";
}

document.querySelector(".admin").addEventListener("click", () => {
  window.location.href = "http://127.0.0.1:5500/pages/admin.html";
})

// Hàm hiển thị danh sách sản phẩm
function renderListProducts(params) {
  let result = "";
  for (let i = 0; i < params.length; i++) {
      result += `
          <div class="product-item" onclick="renderProductItem('${params[i].id}')">
              <div class="product-image">
                  <img src="${params[i].img}" alt="">
              </div>
              <div class="product-description">   
                  <div class="product-type">
                      <span>${params[i].type}</span>
                      <span>S-M-L</span>
                  </div>
                  <h4 class="product-name">${params[i].name}</h4>
                  <p>${USDollar.format(params[i].price)}</p>
              </div>
          </div>
          `
  }
  document.querySelector(".content-container").innerHTML = result;
  document.querySelector(".content-container").style.display = "flex";
  document.querySelector(".banner-container").style.display = "none";
  document.querySelector(".footer-container").classList.remove("active-footer");
}

function renderListAllProducts() {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  renderListProducts(listProducts);
  document.querySelector(".listPage").style.display = "block";
  pagination();
}

function renderWomenListProducts() {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listProductsWomen = [];
  for (let i = 0; i < listProducts.length; i++) {
      if (listProducts[i].type == "WOMEN") {
          listProductsWomen.push(listProducts[i])
      }
  }
  renderListProducts(listProductsWomen);
  document.querySelector(".listPage").style.display = "none";
}

function renderMenListProducts() {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listProductsMen = [];
  for (let i = 0; i < listProducts.length; i++) {
      if (listProducts[i].type == "MEN") {
          listProductsMen.push(listProducts[i])
      }
  }
  renderListProducts(listProductsMen);
  document.querySelector(".listPage").style.display = "none";
}

function renderKidsListProducts() {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listProductsKids = [];
  for (let i = 0; i < listProducts.length; i++) {
      if (listProducts[i].type == "KIDS") {
          listProductsKids.push(listProducts[i])
      }
  }
  renderListProducts(listProductsKids);
  document.querySelector(".listPage").style.display = "none";
}

function renderBabyListProducts() {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listProductsBaby = [];
  for (let i = 0; i < listProducts.length; i++) {
      if (listProducts[i].type == "BABY") {
          listProductsBaby.push(listProducts[i])
      }
  }
  renderListProducts(listProductsBaby);
  document.querySelector(".listPage").style.display = "none";
}

// Hàm hiển thị chi tiết từng sản phẩm

function renderProductItem(idProduct) {

  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let productItem = listProducts.find((item) => {
      return item.id == idProduct
  })

  let result = `
      <div class="product">
          <div class="productItem-image">
              <div class="productItem-main-image">
              <img src="${productItem.img}" alt="" class="main-image">
          </div>
              <div class="productItem-image-color">
          
              </div>
          </div>
          <div class="productItem-description">
              <h2>${productItem.name}</h2>
              <h3>${USDollar.format(productItem.price)}</h3>
              <p>${productItem.des}</p>
              <h4>Size</h4>
              <div>
                  <input type="radio" id="S" value="S" name="size" class="size-option">
                  <label for="S">S</label>
                  <br>
                  <input type="radio" id="M" value="M" name="size" class="size-option">
                  <label for="M">M</label>
                  <br>
                  <input type="radio" id="L" value="L" name="size" class="size-option">
                  <label for="L">L</label>
              </div>
              <button class="addtocart-button" onclick="addToCart('${productItem.id}')">ADD TO CART</button><br>
              <p class="product-idOption">${productItem.options[0].idOption}</p>
              <span class="stock-size-S">Size S available in stock ${productItem.options[0].sizes[0].stock}</span><br>
              <span class="stock-size-M">Size M available in stock ${productItem.options[0].sizes[1].stock}</span><br>
              <span class="stock-size-L">Size L available in stock ${productItem.options[0].sizes[2].stock}</span>
          </div>
      </div>
      `;
  document.querySelector(".content-container").style.display = "flex";
  document.querySelector(".content-container").innerHTML = result;
  document.querySelector(".banner-container").style.display = "none";
  let productItemColor = document.querySelector(".productItem-image-color");

  let productColors = "";
  for (let i = 0; i < productItem.options.length; i++) {

      productColors += `
          <img src="${productItem.options[i].src}" alt="" onclick="changeProductColor(${idProduct}, '${productItem.options[i].src}', '${productItem.options[i].idOption}')">
      `
  }
  productItemColor.innerHTML = productColors;
}

function changeProductColor(idProduct, src, idOption) {
  // console.log(idProduct);
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let product = listProducts.find((product) => {
      return product.id == idProduct;
  })
  let option = product.options.find((option) => {
      return option.idOption == idOption;
  })
  document.querySelector(".main-image").src = `${src}`;
  document.querySelector(".product-idOption").innerHTML = `${idOption}`;

  document.querySelector(".stock-size-S").innerHTML = `Size S available in stock ${option.sizes[0].stock}`;
  document.querySelector(".stock-size-M").innerHTML = `Size M available in stock ${option.sizes[1].stock}`;
  document.querySelector(".stock-size-L").innerHTML = `Size L available in stock ${option.sizes[2].stock}`;
}

// Hàm thêm sản phẩm vào giỏ hàng

function addToCart(idProduct) {
  let checkLogin = localStorage.getItem("checkLogin");

  if (checkLogin == null) {
      showErrorNotLoginToast();
      return;
  }

  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let selectedSize = null;
  let idOption = document.querySelector(".product-idOption").innerHTML;

  const sizeOptions = document.querySelectorAll(".size-option");
  for (let i = 0; i < sizeOptions.length; i++) {
      if (sizeOptions[i].checked) {
          selectedSize = sizeOptions[i].value;
          break;
      }
  }

  if (selectedSize === null) {
      showErrorSizeToast();
      return;
  }

  let product = listProducts.find((product) => {
      return product.id == idProduct;
  });

  let option = product.options.find((x) => {
      return x.idOption == idOption
  })

  let imageLink = option.src;
  let productName = product.name;
  let productPrice = product.price;

  for (let i = 0; i < listUsers.length; i++) {
      if (listUsers[i].idUser == checkLogin) {
          let cart = listUsers[i].cartUser;

          // Check if the product with the same idOption and selectedSize already exists in the cart
          let existingProduct = cart.find((item) => {
              return item.idOption == idOption && item.size == selectedSize;
          });

          if (existingProduct) {
              // Increment the quantity if the product already exists
              existingProduct.quantity++;
              localStorage.setItem("listUsers", JSON.stringify(listUsers));
              showCartProductTotal()
          } else {
              // Add the product to the cart with quantity 1, image link, and product name
              cart.push({
                  idProduct: idProduct,
                  idOption: idOption,
                  size: selectedSize,
                  quantity: 1,
                  imageLink: imageLink,
                  productName: productName,
                  productPrice: productPrice
              });
              localStorage.setItem("listUsers", JSON.stringify(listUsers));
              showCartProductTotal()
          }
      }
  }
}


// Hàm hiển thị tổng số lượng sản phẩm trong giỏ hàng
function showCartProductTotal() {
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");

  let user = listUsers.find((item) => {
      return item.idUser == checkLogin;
  })

  let cartUser = user.cartUser;

  let total = cartUser.reduce((total, currentValue) => {
      return total += currentValue.quantity;
  }, 0)

  document.querySelector(".cart-quantity").innerHTML = `${total}`;
}

showCartProductTotal();

// Hàm hiển thị danh sách sản phẩm trong giỏ hàng
function showCartProducts() {
  document.querySelector(".cartProducts-container").style.display = "block";
  document.querySelector(".nagivation-container").style.opacity = 0.5;
  document.querySelector(".content-container").style.opacity = 0.5;
  document.querySelector(".banner-container").style.opacity = 0.5;

  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");

  let user = listUsers.find((user) => {
      return user.idUser == checkLogin;
  })

  let cartUser = user.cartUser;

  let result = "";
  for (let i = 0; i < cartUser.length; i++) {
      result += `
          <div class="cartProductItem" id = "cartProductItem_${i}">
              <div class="cartItem">
                  <div class="cartProductItem-image">
                      <img src="${cartUser[i].imageLink}" alt="">
                  </div>
                  <div class="cartProductItem-info">
                      <h4>${cartUser[i].productName}</h4>
                      <p>Product code: ${cartUser[i].idOption}</p>
                      <p>Size: ${cartUser[i].size}</p>
                      <p>${USDollar.format(cartUser[i].productPrice)}</p>
                          <div class="changeQuantity-button">
                              <button>
                                  <span class="material-symbols-outlined" onclick="decreaseItem(${i})">
                                      remove
                                  </span>
                              </button>
                              
                              <span class="productItem-quantity" id="quantity">${cartUser[i].quantity}</span>

                              <button>
                                  <span class="material-symbols-outlined" onclick="increaseItem(${i})">
                                      add
                                  </span>
                              </button>
                          </div>
                  </div>
              </div>
              <div class="cartItem-delete-button" onclick = "deleteCartProductItem(${i})">
                      <span class="material-symbols-outlined">
                          close
                      </span>
              </div>
          </div>
      `;
  }
  document.querySelector(".cartProductItems").innerHTML = result;
  caculateTotalProductsPrice();
}

document.querySelector(".cartProducts-close").addEventListener("click", () => {
  document.querySelector(".cartProducts-container").style.display = "none";
  document.querySelector(".nagivation-container").style.opacity = 1;
  document.querySelector(".content-container").style.opacity = 1;
  document.querySelector(".banner-container").style.opacity = 1;
})


// Hàm tăng số lượng sản phẩm
function increaseItem(index) {
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");

  // Find the user in listUsers
  for (let i = 0; i < listUsers.length; i++) {
      if (listUsers[i].idUser == checkLogin) {
          let cartUser = listUsers[i].cartUser;
          for (let j = 0; j < cartUser.length; j++) {
              if (j == index) {
                  cartUser[j].quantity += 1;
                  localStorage.setItem("listUsers", JSON.stringify(listUsers));
                  showCartProducts();
                  showCartProductTotal();
                  caculateTotalProductsPrice();
                  return;
              }
          }
      }
  }
}

// Hàm giảm số lượng sản phẩm
function decreaseItem(index) {
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");

  for (let i = 0; i < listUsers.length; i++) {
      if (listUsers[i].idUser == checkLogin) {
          let cartUser = listUsers[i].cartUser;
          for (let j = 0; j < cartUser.length; j++) {
              if (cartUser[index].quantity > 1) {
                  cartUser[index].quantity -= 1;
                  localStorage.setItem("listUsers", JSON.stringify(listUsers));
                  showCartProducts();
                  showCartProductTotal();
                  caculateTotalProductsPrice();
                  return;
              } else {
                  cartUser.splice(index, 1);
                  localStorage.setItem("listUsers", JSON.stringify(listUsers));
                  showCartProducts();
                  showCartProductTotal();
                  caculateTotalProductsPrice();
                  return;
              }
          }
      }
  }
}


// Hàm xoá sản phẩm trong giỏ hàng  
function deleteCartProductItem(index) {
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");
  let user = listUsers.find((item) => item.idUser == checkLogin);
  let cartUser = user.cartUser;
  cartUser.splice(index, 1);
  localStorage.setItem("listUsers", JSON.stringify(listUsers));
  showCartProducts();
  showCartProductTotal();
  caculateTotalProductsPrice();
}

// Hàm tính tổng tiền sản phẩm có trong giỏ hàng
function caculateTotalProductsPrice() {
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");
  let user = listUsers.find((item) => item.idUser == checkLogin);
  let cartUser = user.cartUser;
  let totalPrice = cartUser.reduce((total, currentValue) => {
      return total += currentValue.productPrice * currentValue.quantity;
  }, 0)
  document.querySelector(".cartProducts-subTotal").innerHTML = `SUBOTAL: ${USDollar.format(totalPrice)}`;
}

// Hàm kiểm tra xem đã đăng nhập hay chưa
function checkLogin() {
  let getIsLogin = localStorage.getItem("checkLogin");
  if (getIsLogin == null) {
      return false;
  } else {
      return true;
  }
}

// Hàm kiểm tra người dùng có phải admin hay không
function checkIsAdmin() {
  let checkLogin = localStorage.getItem("checkLogin");
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let user = listUsers.find((user) => {
      return user.idUser == checkLogin;
  })
  console.log("admin", user.isAdmin, user)
  if (user.isAdmin) {
      return true;
  } else {
      return false;
  }
}

// Hàm kiểm tra đã đăng xuất hay chưa
function checkLogout() {
  let confirmLogout = confirm("Bạn có muốn thoát không");
  if (confirmLogout) {
      localStorage.removeItem("checkLogin");
      window.location.href = "index.html";
      document.querySelector(".logout-button").style.visibility = "hidden";
  }
}

// Hàm thực thi phân trang
function pagination() {
  let thisPage = 1;
  let limit = 8;
  let list = document.querySelectorAll(".product-item");

  function loadItem() {
      let beginGet = limit * (thisPage - 1);
      let endGet = limit * thisPage - 1;
      list.forEach((item, key) => {
          if (key >= beginGet && key <= endGet) {
              item.style.display = 'block';
          } else {
              item.style.display = 'none';
          }
      })
      listPage();
  }
  loadItem();
  function listPage() {
      let count = Math.ceil(list.length / limit);
      document.querySelector('.listPage').innerHTML = '';

      if (thisPage != 1) {
          let prev = document.createElement('li');
          prev.innerText = 'PREV';
          prev.setAttribute('onclick', "changePage(" + (thisPage - 1) + ")");
          document.querySelector('.listPage').appendChild(prev);
      }

      for (i = 1; i <= count; i++) {
          let newPage = document.createElement('li');
          newPage.innerText = i;
          if (i == thisPage) {
              newPage.classList.add('active');
          }
          newPage.setAttribute('onclick', "changePage(" + i + ")");
          document.querySelector('.listPage').appendChild(newPage);
      }

      if (thisPage != count) {
          let next = document.createElement('li');
          next.innerText = 'NEXT';
          next.setAttribute('onclick', "changePage(" + (thisPage + 1) + ")");
          document.querySelector('.listPage').appendChild(next);
      }
  }
  function changePage(i) {
      thisPage = i;
      loadItem();
  }

  // Attach the changePage function to the global object
  window.changePage = changePage;
}

// Hàm chuyển đến trang thanh toán đơn hàng
document.querySelector(".cartProducts-checkout-btn").addEventListener("click", () => {
  document.querySelector(".cartProducts-container").style.display = "none";
  document.querySelector(".banner-container").style.display = "none";
  document.querySelector(".nagivation-container").style.opacity = 1;
  renderOrderedProductsList();
})

// Hàm hiển thị sản phẩm đã thêm vào giỏ hàng trong đơn hàng
function renderOrderedProductsList() {
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");
  let user = listUsers.find((user) => {
      return user.idUser == checkLogin;
  })

  let cartUser = user.cartUser;
  let totalOrders = cartUser.reduce((total, currentValue) => {
      return total += currentValue.quantity;
  }, 0)

  let totalOrdersPrice = cartUser.reduce((total, currentValue) => {
      return total += currentValue.productPrice * currentValue.quantity;
  }, 0)

  let result = "";
  for (let i = 0; i < cartUser.length; i++) {
      result += `
          <div class="ordered-product">
              <div class="ordered-product-img">
                  <img src="${cartUser[i].imageLink}" alt="">
              </div>
              <p class="product-quantity">x${cartUser[i].quantity}</p>
          </div>
          `;
  }
  document.querySelector(".content-container").innerHTML = `
          <div class="checkout-container">
                  <div class="userInfo">
                      <h3>REGISTER A NEW ADDRESS</h3>
                      <div class="userInfo-form">
                          <div class="form-group">
                              <label for="firstname">FIRST NAME</label><br>
                              <input type="text" id="firstname" name="firstname" placeholder="Please enter your first name" class="form-control">
                          </div>
                          <div class="form-group">
                              <label for="lastname">LAST NAME</label><br>
                              <input type="text" id="lastname" name="lastname" placeholder="Please enter your last name" class="form-control">
                          </div>
                          <div class="form-group">
                              <label for="provice">PROVINCE</label><br>
                              <input type="text" id="province" name="province" placeholder="Please enter your provice" class="form-control">
                          </div>
                          <div class="form-group">
                              <label for="district">DISTRICT</label><br>
                              <input type="text" id="district" name="district" placeholder="Please enter your district" class="form-control">
                          </div>
                          <div class="form-group">
                              <label for="address">ADDRESS DETAILS</label><br>
                              <input id="address" name="address" type="text" placeholder="Apartment, suites, zones, buildings, floors etc" class="form-control"><br>
                          </div>
                          <div class="form-group">
                              <label for="phone">PHONE</label><br>
                              <input id="phone" name="phone" type="text" placeholder="Enter 10-11 numbers starting with 0" class="form-control"><br>
                          </div>
                          <div class="form-group">
                              <label for="mobilePhone">MOBILE PHONE</label><br>
                              <input id="mobilePhone" name="mobilePhone" type="text" placeholder="Enter 10-11 numbers starting with 0" class="form-control"><br>
                          </div>
                          <p>We may contact you by phone or email if we have questions about your order and shipping options.</p>
                          <input type="checkbox" class="showPassword">
                          <span>Use as billing address</span><br>
                          <button class="continue-checkout" onclick = "checkout()">CONTINUE CHECKOUT</button>
                      </div>
                  </div>
                  <div class="total-orders">
                      <div class="total-orders-detail">
                          <p class="total-orders-quantity">TOTAL ORDERS | ${totalOrders} PRODUCTS</p>
                          <p class="total-orders-price">TOTAL ${USDollar.format(totalOrdersPrice)}</p>
                          <p class="total-orders-tax">Value added tax included ${USDollar.format(0.05 * totalOrdersPrice)}</p>
                          <p class="total-orders-price-tax">TOTAL ORDERS ${USDollar.format(1.05 * totalOrdersPrice)}</p>
                      </div>
                      <div class="ordered-products">
                          ${result}
                      </div>
                  </div>
          </div>
      `;

  document.querySelector(".footer-container").classList.add("active-footer");
  let firstName = document.querySelector("#firstname");
  let lastName = document.querySelector("#lastname");
  let province = document.querySelector("#province");
  let district = document.querySelector("#district");
  let address = document.querySelector("#address");
  let phone = document.querySelector("#phone");
  let mobilePhone = document.querySelector("#mobilePhone");
  firstName.value = user.userInfo.firstName;
  lastName.value = user.userInfo.lastName;
  province.value = user.userInfo.province;
  district.value = user.userInfo.district;
  address.value = user.userInfo.address;
  phone.value = user.userInfo.phone;
  mobilePhone.value = user.userInfo.mobilePhone;
}


function validateUserInfo() {
  let firstName = document.querySelector("#firstname");
  let lastName = document.querySelector("#lastname");
  let province = document.querySelector("#province");
  let district = document.querySelector("#district");
  let address = document.querySelector("#address");
  let phone = document.querySelector("#phone");
  let mobilePhone = document.querySelector("#mobilePhone");
  let inputElement = document.getElementsByClassName("form-control");
  if (firstName.value == "" || lastName.value == "" || province.value == "" || district.value == "" || address.value == "") {
      for (let i = 0; i < inputElement.length; i++) {
          inputElement[i].classList.add("invalid");
      }
  } else {
      for (let i = 0; i < inputElement.length; i++) {
          inputElement[i].classList.remove("invalid");
      }
  }
  let userInfo = {
      firstName: firstName.value,
      lastName: lastName.value,
      province: province.value,
      district: district.value,
      address: address.value,
      phone: phone.value,
      mobilePhone: mobilePhone.value
  }
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");
  let user = listUsers.find((user) => {
      return user.idUser == checkLogin;
  })

  user.userInfo = userInfo;
  localStorage.setItem("listUsers", JSON.stringify(listUsers));
}

function getInforProductInProductLocal(productId) {
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  for (let i in listProducts) {
      if (listProducts[i].id == productId) {
          return listProducts[i];
      }
  }
  return false;
}

function validCart(cart, product) {
  for (let j in product.options) {
      for (let k in product.options[j].sizes) {
          if (product.options[j].sizes[k].key == cart.size) {
              if (cart.quantity > product.options[j].sizes[k].stock) {
                  return {
                      status: false,
                      name: product.name,
                      stock: product.options[j].sizes[k].stock
                  }
              }
          }
      }
  }
  return {
      status: true
  }
}

function validCartAndUpdateStore(cart, product) {
  for (let j in product.options) {
      if (cart.idOption == product.options[j].idOption) {
          for (let k in product.options[j].sizes) {
              if (product.options[j].sizes[k].key == cart.size) {
                  product.options[j].sizes[k].stock -= cart.quantity;

                  let productList = JSON.parse(localStorage.getItem("listProducts"));
                  for (let i in productList) {
                      if (productList[i].id == product.id) {
                          productList[i] = product;
                          localStorage.setItem("listProducts", JSON.stringify(productList)); // save to local
                          console.log("da tru")
                          return;
                      }
                  }
              }
          }
      }
  }
}

function validateCartProduct() {
  // ...Các bước kiểm tra thông tin người dùng và lấy các giá trị cần thiết...
  let listProducts = JSON.parse(localStorage.getItem("listProducts"));
  let listUsers = JSON.parse(localStorage.getItem("listUsers"));
  let checkLogin = localStorage.getItem("checkLogin");
  let user = listUsers.find((user) => {
      return user.idUser == checkLogin;
  })
  let cartUser = user.cartUser;

  for (let i in cartUser) {
      let validValue = validCart(cartUser[i], getInforProductInProductLocal(cartUser[i].idProduct));
      if (!validValue.status) {
          alert("Mon hang " + validValue.name + " chi con: " + validValue.stock + " san pham");
          return
      }
  }

  // tru trong store

  for (let i in cartUser) {
      let validValue = validCart(cartUser[i], getInforProductInProductLocal(cartUser[i].idProduct));
      if (validValue.status) {
          validCartAndUpdateStore(cartUser[i], getInforProductInProductLocal(cartUser[i].idProduct));
          user.purchaseHistory.push([...cartUser]);
          cartUser.length = 0;
          localStorage.setItem("listUsers", JSON.stringify(listUsers));
      }
  }

}

function checkout() {
  console.log("checkout");
  validateCartProduct();
  validateUserInfo();
  FinalCheckout();
  document.querySelector(".cart-quantity").innerHTML = 0;
}

function FinalCheckout() {
  document.querySelector(".content-container").innerHTML = `
      <div class="final-checkout">
          <h1>Thanks for your purchase!</h1>
      </div>
  `
}
